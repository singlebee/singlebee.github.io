<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>心情记录 - 云端同步版</title>
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
      :root {
        --bg-color: #1e293b;
        --input-bg: #0f172a;
        --text-main: #ffffff;
        --text-dim: #94a3b8;
        --accent-red: #ef4444;
        --btn-blue: #3b82f6;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        justify-content: center;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .app-container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* 状态显示区 */
      .header-info {
        text-align: center;
        margin-bottom: 10px;
      }
      .base-score {
        color: var(--text-dim);
        font-size: 0.9rem;
        margin-bottom: 5px;
      }
      .current-score {
        font-size: 3.5rem;
        font-weight: bold;
        color: var(--accent-red);
        margin: 10px 0;
      }
      .range-info {
        color: #64748b;
        font-size: 0.85rem;
      }

      /* 竖直滑块区 - 自适应高度 */
      .slider-wrapper {
        flex: 1;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 0;
        min-height: 200px;
      }

      input[type="range"] {
        -webkit-appearance: none;
        width: 300px; /* 逻辑上的宽度，因为旋转了 */
        height: 12px;
        background: #334155;
        border-radius: 6px;
        outline: none;
        transform: rotate(-90deg); /* 关键：旋转成竖直 */
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 40px;
        background: #475569;
        border: 2px solid #94a3b8;
        border-radius: 4px;
        cursor: pointer;
      }

      /* 输入与按钮区 */
      .bottom-panel {
        width: 100%;
        margin-top: auto;
      }
      .label {
        color: var(--text-main);
        font-size: 1rem;
        margin-bottom: 8px;
        align-self: flex-start;
      }

      .note-input {
        width: 100%;
        background-color: var(--input-bg);
        border: none;
        color: white;
        padding: 15px;
        border-radius: 4px;
        font-size: 1rem;
        margin-bottom: 20px;
      }

      .sync-btn {
        width: 100%;
        background-color: var(--btn-blue);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 4px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .sync-btn:active {
        opacity: 0.8;
      }
      .sync-btn:disabled {
        background-color: #475569;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="header-info">
        <div class="base-score" id="baseLabel">今日基准: --</div>
        <div class="current-score" id="valShow">--</div>
        <div class="range-info" id="rangeLabel">范围: -- ~ --</div>
      </div>

      <div class="slider-wrapper">
        <input
          type="range"
          id="moodSlider"
          step="0.1"
          oninput="updateDisplay(this.value)"
        />
      </div>

      <div class="bottom-panel">
        <div class="label">备注:</div>
        <input type="text" id="noteInput" class="note-input" placeholder="" />
        <button class="sync-btn" id="saveBtn" onclick="saveToCloud()">
          同步到云端
        </button>
      </div>
    </div>

    <script>
      // 配置与 Python 端一致
      const GIST_ID = "64d655612bbf83409c8754f849349ebd";
      const TOKEN = "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";
      const RAW_URL = `https://gist.githubusercontent.com/singlebee/${GIST_ID}/raw/mood_data.json`;

      let rawData = { history: [] };
      let prevClose = 100;

      // 初始化加载
      async function init() {
        try {
          const resp = await fetch(`${RAW_URL}?t=${Date.now()}`);
          rawData = await resp.json();
          calculateLogic();
        } catch (e) {
          alert("初始化同步失败");
        }
      }

      function calculateLogic() {
        const todayStr = dayjs().format("YYYY-MM-DD");
        // 1. 确保数据按日期排序
        const history = rawData.history.sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );

        let lastScore = 100; // 默认值

        if (history.length > 0) {
          const lastEntry = history[history.length - 1];

          // --- 核心修改点 1：获取最后一次提交的数值 ---
          lastScore = lastEntry.close;

          // --- 核心修改点 2：计算基准分（用于限制滑动范围） ---
          if (lastEntry.date === todayStr) {
            // 如果最后一条是今天的，基准分应是昨天的收盘价
            prevClose =
              history.length > 1
                ? history[history.length - 2].close
                : lastEntry.open;
          } else {
            // 如果还没到今天，基准分就是最后一次记录的收盘价
            prevClose = lastEntry.close;
          }
        }

        const min = (prevClose * 0.9).toFixed(2);
        const max = (prevClose * 1.1).toFixed(2);

        const slider = document.getElementById("moodSlider");
        slider.min = min;
        slider.max = max;

        // --- 核心修改点 3：滑块初始值设为最后一次提交的分数 ---
        slider.value = lastScore;

        document.getElementById(
          "baseLabel"
        ).innerText = `今日基准: ${prevClose}`;
        document.getElementById(
          "rangeLabel"
        ).innerText = `范围: ${min} ~ ${max}`;

        // 更新大数字显示
        updateDisplay(lastScore);
      }
      function updateDisplay(v) {
        document.getElementById("valShow").innerText = parseFloat(v).toFixed(2);
      }

      async function saveToCloud() {
        const btn = document.getElementById("saveBtn");
        btn.disabled = true;
        btn.innerText = "正在同步...";

        const score = parseFloat(document.getElementById("moodSlider").value);
        const note = document.getElementById("noteInput").value;
        const todayStr = dayjs().format("YYYY-MM-DD");
        const nowTime = dayjs().format("HH:mm");

        let today = rawData.history.find((h) => h.date === todayStr);
        if (!today) {
          today = {
            date: todayStr,
            open: prevClose,
            intraday: [{ time: "00:00", score: prevClose, note: "起航" }],
          };
          rawData.history.push(today);
        }

        today.intraday.push({ time: nowTime, score: score, note: note });
        const scores = today.intraday.map((i) => i.score);
        today.high = Math.max(...scores);
        today.low = Math.min(...scores);
        today.close = score;

        try {
          const resp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
            method: "PATCH",
            headers: {
              Authorization: `token ${TOKEN}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              files: {
                "mood_data.json": { content: JSON.stringify(rawData, null, 2) },
              },
            }),
          });
          if (resp.ok) {
            alert("同步成功！");
            document.getElementById("noteInput").value = "";
            init(); // 重新拉取最新状态
          }
        } catch (e) {
          alert("网络错误，提交失败");
        }
        btn.disabled = false;
        btn.innerText = "同步到云端";
      }

      window.onload = init;
    </script>
  </body>
</html>
